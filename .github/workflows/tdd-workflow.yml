name: Multi-Agent TDD Workflow

on:
  workflow_dispatch:
    inputs:
      feature_description:
        description: 'êµ¬í˜„í•  ê¸°ëŠ¥ ì„¤ëª… (ìƒì„¸íˆ ì‘ì„±í• ìˆ˜ë¡ ê²°ê³¼ê°€ ì¢‹ìŠµë‹ˆë‹¤)'
        required: true
        type: string
      branch_name:
        description: 'ìƒì„±í•  ë¸Œëœì¹˜ ì´ë¦„ (ì˜ˆ: feature/add-hospital-search)'
        required: true
        type: string

jobs:
  tdd-workflow:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      # â”€â”€ ì´ˆê¸° ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Setup Git & Branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin \
            https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          chmod +x mvnw
          git checkout -b ${{ inputs.branch_name }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ROUND 1
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: "[R1] Developer - êµ¬í˜„"
        uses: anthropics/claude-code-action@v1
        with:
          use_bedrock: "true"
          github_token: ${{ github.token }}
          claude_args: "--max-turns 30"
          settings: '{"permissions":{"allow":["Bash"],"deny":[]}}'
          prompt: |
            # TDD ê°œë°œ ì—ì´ì „íŠ¸ â€” Round 1/3

            ## êµ¬í˜„ ìš”ì²­
            ${{ inputs.feature_description }}

            ## í”„ë¡œì íŠ¸ êµ¬ì¡° (src/main/java/com/goodoc/demo/)
            - controller/   : @RestController, HTTP ì²˜ë¦¬ë§Œ
            - service/      : ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§, @Transactional ê´€ë¦¬
            - repository/   : Spring Data JPA Interface
            - entity/       : JPA @Entity
            - dto/          : Request/Response DTO
            - exception/    : GlobalExceptionHandler (ê¸°ì¡´ ìœ ì§€)

            ## í•„ìˆ˜ ì½”ë“œ ì»¨ë²¤ì…˜
            - Controller: HTTPë§Œ ì²˜ë¦¬, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ Serviceë¡œ
            - Service: í´ë˜ìŠ¤ì— @Transactional(readOnly=true), ì“°ê¸° ë©”ì„œë“œë§Œ @Transactional
            - DTO: Response.from(entity) ì •ì  íŒ©í† ë¦¬ íŒ¨í„´ ì‚¬ìš©
            - ì—ëŸ¬: IllegalArgumentException â†’ 404, IllegalStateException â†’ 409
            - GlobalExceptionHandlerê°€ ì´ë¯¸ ì²˜ë¦¬í•˜ë¯€ë¡œ try-catch ë¶ˆí•„ìš”
            - Lombok ë¯¸ì‚¬ìš©, getter/setter ì§ì ‘ ì‘ì„±
            - Bean Validation (@NotNull, @NotBlank ë“±) í•„ìˆ˜ í•„ë“œì— ì ìš©

            ## ì§€ì‹œì‚¬í•­
            1. ê¸°ì¡´ ì½”ë“œ íŒŒì•…:
               - ls src/main/java/com/goodoc/demo/
               - ì—°ê´€ íŒŒì¼ë“¤ í™•ì¸
            2. ìš”ì²­ ê¸°ëŠ¥ì— í•„ìš”í•œ íŒŒì¼ ìƒì„±/ìˆ˜ì • (Entity, DTO, Repository, Service, Controller)
            3. ì»´íŒŒì¼ í™•ì¸: ./mvnw compile -q
               - ì‹¤íŒ¨ ì‹œ ì˜¤ë¥˜ í™•ì¸ í›„ ìˆ˜ì •, ì¬ì‹¤í–‰
               - ë°˜ë“œì‹œ ì»´íŒŒì¼ í†µê³¼ í›„ ì§„í–‰
            4. ë³€ê²½ëœ êµ¬í˜„ íŒŒì¼ë§Œ ì»¤ë°‹:
               git add src/main/ && git commit -m "feat: [R1] <ê¸°ëŠ¥ í•œì¤„ ìš”ì•½>"

      - name: "[R1] Run Tests"
        id: test_r1
        continue-on-error: true
        run: |
          set -o pipefail
          ./mvnw test 2>&1 | tee test-output-r1.txt
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: "[R1] Validator - í…ŒìŠ¤íŠ¸ ì‘ì„± ë° ê²€ì¦"
        uses: anthropics/claude-code-action@v1
        with:
          use_bedrock: "true"
          github_token: ${{ github.token }}
          claude_args: "--max-turns 30"
          settings: '{"permissions":{"allow":["Bash"],"deny":[]}}'
          prompt: |
            # TDD ê²€ì¦ ì—ì´ì „íŠ¸ â€” Round 1/3

            ## í˜„ì¬ í…ŒìŠ¤íŠ¸ ê²°ê³¼
            - exit_code: ${{ steps.test_r1.outputs.exit_code }} (0=ì„±ê³µ)
            - ìƒì„¸ ë‚´ìš©: cat test-output-r1.txt

            ## ì§€ì‹œì‚¬í•­

            ### 1ë‹¨ê³„: ê¸°ì¡´ ìƒíƒœ íŒŒì•…
            - cat test-output-r1.txt ë¡œ í˜„ì¬ í…ŒìŠ¤íŠ¸ ê²°ê³¼ í™•ì¸
            - git log --oneline -5 ë¡œ ê°œë°œì ì»¤ë°‹ í™•ì¸
            - ì‹ ê·œ/ìˆ˜ì •ëœ src/main/ íŒŒì¼ë“¤ ì½ì–´ êµ¬í˜„ ë‚´ìš© íŒŒì•…

            ### 2ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ì‘ì„±
            src/test/java/com/goodoc/demo/ ì•„ë˜ì— í…ŒìŠ¤íŠ¸ íŒŒì¼ ì‘ì„±:
            - @SpringBootTest + MockMvc í™œìš© (spring-boot-starter-test ì‚¬ìš© ê°€ëŠ¥)
            - ë°˜ë“œì‹œ í¬í•¨í•  ì¼€ì´ìŠ¤:
              * ì •ìƒ ì¼€ì´ìŠ¤ (201/200 ì‘ë‹µ)
              * ì˜ëª»ëœ ì…ë ¥ (400 Bad Request â€” Bean Validation ê²€ì¦)
              * ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ID (404 â€” IllegalArgumentException)
              * ì¤‘ë³µ/ìƒíƒœ ì˜¤ë¥˜ (409 â€” IllegalStateException)
            - ê° ì—”ë“œí¬ì¸íŠ¸ë‹¹ ìµœì†Œ 3ê°œ ì´ìƒ í…ŒìŠ¤íŠ¸

            ### 3ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ìˆ˜ì •
            - ./mvnw test ì‹¤í–‰
            - ì‹¤íŒ¨ ì‹œ í…ŒìŠ¤íŠ¸ ì½”ë“œ ìˆ˜ì • í›„ ì¬ì‹¤í–‰ (êµ¬í˜„ ì½”ë“œ ìˆ˜ì •ì€ ìµœì†Œí™”)
            - ìµœëŒ€ 3íšŒ ì¬ì‹œë„

            ### 4ë‹¨ê³„: ì½”ë“œ í’ˆì§ˆ ë¦¬ë·°
            êµ¬í˜„ ì½”ë“œì—ì„œ ë‹¤ìŒ í•­ëª© ê²€í† :
            - [ ] Controllerì— ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì—†ëŠ”ì§€
            - [ ] @Transactional ì˜¬ë°”ë¥¸ ì‚¬ìš© (readOnly=true ê¸°ë³¸)
            - [ ] IllegalArgumentException=404, IllegalStateException=409 ì¤€ìˆ˜
            - [ ] Response.from(entity) íŒ¨í„´ ì‚¬ìš©
            - [ ] Bean Validation ì ìš©

            ### 5ë‹¨ê³„: ê²°ê³¼ íŒŒì¼ ì‘ì„±
            tdd-feedback.md íŒŒì¼ ì‘ì„± (ë‹¤ìŒ ë¼ìš´ë“œ ê°œë°œìê°€ ì½ì„ íŒŒì¼):
            ```
            # Round 1 ê²€ì¦ ê²°ê³¼

            ## í…ŒìŠ¤íŠ¸ ê²°ê³¼: PASS/FAIL
            ### ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸: (ìˆì„ ê²½ìš° ëª©ë¡)

            ## ì½”ë“œ í’ˆì§ˆ ì´ìŠˆ
            ### (ê° ì´ìŠˆë¥¼ êµ¬ì²´ì ì¸ íŒŒì¼/ë¼ì¸ ì •ë³´ì™€ í•¨ê»˜)

            ## ìˆ˜ì • ì§€ì‹œì‚¬í•­ (ë‹¤ìŒ ë¼ìš´ë“œ ê°œë°œìì—ê²Œ)
            ### (êµ¬ì²´ì ìœ¼ë¡œ ë¬´ì—‡ì„ ì–´ë–»ê²Œ ìˆ˜ì •í•´ì•¼ í•˜ëŠ”ì§€)
            ```

            tdd-verdict.txt ì‘ì„±:
            - ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼ + í’ˆì§ˆ ì´ìŠˆ ì—†ìŒ: ì²« ì¤„ì— ì •í™•íˆ "PASS" (ë”°ì˜´í‘œ ì—†ì´)
            - ê·¸ ì™¸: ì²« ì¤„ì— "FAIL: <ì´ìœ  í•œì¤„>" í˜•ì‹

            ### 6ë‹¨ê³„: ì»¤ë°‹
            git add src/test/ tdd-feedback.md tdd-verdict.txt && \
            git commit -m "test: [R1] í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ì¶”ê°€ ë° ê²€ì¦ ê²°ê³¼"

      - name: "[R1] Check"
        id: check_r1
        run: |
          verdict=$(head -1 tdd-verdict.txt 2>/dev/null || echo "FAIL: verdict íŒŒì¼ ì—†ìŒ")
          echo "verdict=${verdict}" >> $GITHUB_OUTPUT
          if [[ "${verdict}" == "PASS" ]]; then
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "passed=false" >> $GITHUB_OUTPUT
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ROUND 2  (Round 1 ì‹¤íŒ¨ ì‹œ)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: "[R2] Developer - ìˆ˜ì •"
        if: steps.check_r1.outputs.passed != 'true'
        uses: anthropics/claude-code-action@v1
        with:
          use_bedrock: "true"
          github_token: ${{ github.token }}
          claude_args: "--max-turns 30"
          settings: '{"permissions":{"allow":["Bash"],"deny":[]}}'
          prompt: |
            # TDD ê°œë°œ ì—ì´ì „íŠ¸ â€” Round 2/3 (ìˆ˜ì •)

            Round 1 íŒì •: ${{ steps.check_r1.outputs.verdict }}

            ## ì§€ì‹œì‚¬í•­
            1. git log --oneline -10 ìœ¼ë¡œ í˜„ì¬ê¹Œì§€ ì»¤ë°‹ í™•ì¸
            2. cat tdd-feedback.md ë¡œ ìƒì„¸ í”¼ë“œë°± í™•ì¸
            3. í”¼ë“œë°±ì˜ ëª¨ë“  ìˆ˜ì • ì§€ì‹œì‚¬í•­ ì ìš©:
               - ì½”ë“œ í’ˆì§ˆ ì´ìŠˆ ìˆ˜ì •
               - í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì›ì¸ì´ êµ¬í˜„ ë²„ê·¸ë¼ë©´ ìˆ˜ì •
            4. ./mvnw compile -q ì»´íŒŒì¼ í™•ì¸
            5. git add src/main/ && git commit -m "fix: [R2] ê²€ì¦ í”¼ë“œë°± ë°˜ì˜"

      - name: "[R2] Run Tests"
        if: steps.check_r1.outputs.passed != 'true'
        id: test_r2
        continue-on-error: true
        run: |
          set -o pipefail
          ./mvnw test 2>&1 | tee test-output-r2.txt
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: "[R2] Validator - ì¬ê²€ì¦"
        if: steps.check_r1.outputs.passed != 'true'
        uses: anthropics/claude-code-action@v1
        with:
          use_bedrock: "true"
          github_token: ${{ github.token }}
          claude_args: "--max-turns 20"
          settings: '{"permissions":{"allow":["Bash"],"deny":[]}}'
          prompt: |
            # TDD ê²€ì¦ ì—ì´ì „íŠ¸ â€” Round 2/3 (ì¬ê²€ì¦)

            exit_code: ${{ steps.test_r2.outputs.exit_code }} (0=ì„±ê³µ)

            ## ì§€ì‹œì‚¬í•­
            1. cat test-output-r2.txt ë¡œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ í™•ì¸
            2. cat tdd-feedback.md ë¡œ Round 1 í”¼ë“œë°± í™•ì¸
               - Round 1ì—ì„œ ì§€ì í•œ ì´ìŠˆê°€ ìˆ˜ì •ëëŠ”ì§€ ê²€í† 
            3. í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ê°€ í…ŒìŠ¤íŠ¸ ì½”ë“œ ë¬¸ì œë¼ë©´ í…ŒìŠ¤íŠ¸ ìˆ˜ì • í›„ ./mvnw test ì¬ì‹¤í–‰
            4. ì½”ë“œ í’ˆì§ˆ ì¬ê²€í†  (Round 1ê³¼ ë™ì¼ ì²´í¬ë¦¬ìŠ¤íŠ¸)
            5. tdd-feedback.md ì— Round 2 ê²°ê³¼ ì¶”ê°€:
               ```
               ---
               # Round 2 ê²€ì¦ ê²°ê³¼
               ## ìˆ˜ì • ë°˜ì˜ ì—¬ë¶€: (Round 1 ì´ìŠˆ í•´ê²°ëëŠ”ì§€)
               ## ì”ì—¬ ì´ìŠˆ: (ìˆì„ ê²½ìš°)
               ## ìˆ˜ì • ì§€ì‹œì‚¬í•­: (ë‹¤ìŒ ë¼ìš´ë“œìš©)
               ```
            6. tdd-verdict.txt ë®ì–´ì“°ê¸°: "PASS" ë˜ëŠ” "FAIL: <ì´ìœ >"
            7. ë³€ê²½ì‚¬í•­ ì»¤ë°‹:
               git add src/test/ tdd-feedback.md tdd-verdict.txt && \
               git commit -m "test: [R2] ì¬ê²€ì¦ ê²°ê³¼" --allow-empty

      - name: "[R2] Check"
        if: steps.check_r1.outputs.passed != 'true'
        id: check_r2
        run: |
          verdict=$(head -1 tdd-verdict.txt 2>/dev/null || echo "FAIL: verdict íŒŒì¼ ì—†ìŒ")
          echo "verdict=${verdict}" >> $GITHUB_OUTPUT
          if [[ "${verdict}" == "PASS" ]]; then
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "passed=false" >> $GITHUB_OUTPUT
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ROUND 3  (Round 2 ì‹¤íŒ¨ ì‹œ)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: "[R3] Developer - ìµœì¢… ìˆ˜ì •"
        if: steps.check_r1.outputs.passed != 'true' && steps.check_r2.outputs.passed != 'true'
        uses: anthropics/claude-code-action@v1
        with:
          use_bedrock: "true"
          github_token: ${{ github.token }}
          claude_args: "--max-turns 30"
          settings: '{"permissions":{"allow":["Bash"],"deny":[]}}'
          prompt: |
            # TDD ê°œë°œ ì—ì´ì „íŠ¸ â€” Round 3/3 (ìµœì¢… ìˆ˜ì •)

            Round 1: ${{ steps.check_r1.outputs.verdict }}
            Round 2: ${{ steps.check_r2.outputs.verdict }}

            ## ì§€ì‹œì‚¬í•­
            1. cat tdd-feedback.md ë¡œ ëˆ„ì  í”¼ë“œë°± ì „ì²´ í™•ì¸
            2. ë¯¸í•´ê²° ì´ìŠˆ ëª¨ë‘ ìˆ˜ì • (ë§ˆì§€ë§‰ ê¸°íšŒ)
            3. ./mvnw compile -q í™•ì¸
            4. git add src/main/ && git commit -m "fix: [R3] ìµœì¢… ìˆ˜ì •"

      - name: "[R3] Run Tests"
        if: steps.check_r1.outputs.passed != 'true' && steps.check_r2.outputs.passed != 'true'
        id: test_r3
        continue-on-error: true
        run: |
          set -o pipefail
          ./mvnw test 2>&1 | tee test-output-r3.txt
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: "[R3] Validator - ìµœì¢… ê²€ì¦"
        if: steps.check_r1.outputs.passed != 'true' && steps.check_r2.outputs.passed != 'true'
        uses: anthropics/claude-code-action@v1
        with:
          use_bedrock: "true"
          github_token: ${{ github.token }}
          claude_args: "--max-turns 20"
          settings: '{"permissions":{"allow":["Bash"],"deny":[]}}'
          prompt: |
            # TDD ê²€ì¦ ì—ì´ì „íŠ¸ â€” Round 3/3 (ìµœì¢…)

            exit_code: ${{ steps.test_r3.outputs.exit_code }} (0=ì„±ê³µ)

            ## ì§€ì‹œì‚¬í•­
            1. cat test-output-r3.txt í™•ì¸
            2. cat tdd-feedback.md ëˆ„ì  í”¼ë“œë°± í™•ì¸
            3. í•„ìš”ì‹œ í…ŒìŠ¤íŠ¸ ë³´ì™„
            4. tdd-feedback.md ì— Round 3 ìµœì¢… ê²°ê³¼ ì¶”ê°€
            5. tdd-verdict.txt ìµœì¢… íŒì •: "PASS" ë˜ëŠ” "FAIL: <ì´ìœ >"
            6. git add src/test/ tdd-feedback.md tdd-verdict.txt && \
               git commit -m "test: [R3] ìµœì¢… ê²€ì¦ ê²°ê³¼" --allow-empty

      - name: "[R3] Check"
        if: steps.check_r1.outputs.passed != 'true' && steps.check_r2.outputs.passed != 'true'
        id: check_r3
        run: |
          verdict=$(head -1 tdd-verdict.txt 2>/dev/null || echo "FAIL: verdict íŒŒì¼ ì—†ìŒ")
          echo "verdict=${verdict}" >> $GITHUB_OUTPUT
          if [[ "${verdict}" == "PASS" ]]; then
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "passed=false" >> $GITHUB_OUTPUT
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ìµœì¢… íŒì •
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Determine Final Result
        if: always()
        id: final
        run: |
          r1="${{ steps.check_r1.outputs.passed }}"
          r2="${{ steps.check_r2.outputs.passed }}"
          r3="${{ steps.check_r3.outputs.passed }}"

          if [[ "$r1" == "true" || "$r2" == "true" || "$r3" == "true" ]]; then
            echo "passed=true" >> $GITHUB_OUTPUT
            rounds=1
            [[ "$r1" != "true" && "$r2" == "true" ]] && rounds=2
            [[ "$r1" != "true" && "$r2" != "true" && "$r3" == "true" ]] && rounds=3
            echo "rounds=${rounds}" >> $GITHUB_OUTPUT
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "rounds=0" >> $GITHUB_OUTPUT
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # í†µê³¼: ë¸Œëœì¹˜ í‘¸ì‹œ & PR ìƒì„±
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Push Branch
        if: steps.final.outputs.passed == 'true'
        run: git push origin ${{ inputs.branch_name }}

      - name: Create PR
        if: steps.final.outputs.passed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ì´ë¯¸ PRì´ ìˆìœ¼ë©´ ìŠ¤í‚µ
          existing=$(gh pr list --head "${{ inputs.branch_name }}" --json number --jq '.[0].number' 2>/dev/null || echo "")
          if [[ -n "$existing" ]]; then
            echo "PR #${existing} ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
            exit 0
          fi

          ROUNDS=${{ steps.final.outputs.rounds }}
          R1="${{ steps.check_r1.outputs.verdict }}"
          R2="${{ steps.check_r2.outputs.verdict }}"
          R3="${{ steps.check_r3.outputs.verdict }}"
          FEEDBACK=$(cat tdd-feedback.md 2>/dev/null | head -100 || echo "N/A")

          gh pr create \
            --title "feat: ${{ inputs.feature_description }}" \
            --body "## ğŸ¤– Multi-Agent TDD ê²°ê³¼

          **ë¸Œëœì¹˜**: \`${{ inputs.branch_name }}\`
          **ì†Œìš” ë¼ìš´ë“œ**: ${ROUNDS}/3

          ### ë¼ìš´ë“œë³„ ê²°ê³¼
          | ë¼ìš´ë“œ | íŒì • |
          |--------|------|
          | Round 1 | ${R1:-'-'} |
          | Round 2 | ${R2:-'-'} |
          | Round 3 | ${R3:-'-'} |

          ### ê²€ì¦ í”¼ë“œë°± ìš”ì•½
          \`\`\`
          ${FEEDBACK}
          \`\`\`

          ---
          ğŸ¤– _Developer Agent(êµ¬í˜„) + Validator Agent(í…ŒìŠ¤íŠ¸/ë¦¬ë·°) í˜‘ì—…ìœ¼ë¡œ ìë™ ìƒì„±_" \
            --base main \
            --head "${{ inputs.branch_name }}"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ì‹¤íŒ¨: 3ë¼ìš´ë“œ ëª¨ë‘ ë¯¸í†µê³¼
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Fail â€” All Rounds Failed
        if: steps.final.outputs.passed == 'false'
        run: |
          echo "âŒ 3ë¼ìš´ë“œ ëª¨ë‘ í†µê³¼í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤."
          echo ""
          echo "=== ëˆ„ì  í”¼ë“œë°± ==="
          cat tdd-feedback.md 2>/dev/null || echo "í”¼ë“œë°± íŒŒì¼ ì—†ìŒ"
          exit 1
